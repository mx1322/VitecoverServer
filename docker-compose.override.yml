services:
  # 🌐 Reverse Proxy — the only externally exposed service
  nginx:
    image: nginx:alpine
    container_name: saleor-nginx
    restart: always
    depends_on:
      - api
      - dashboard
    ports:
      - "80:80"  # Expose only HTTP
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - saleor-media:/app/media:ro
      - ./dashboard.config.js:/usr/share/nginx/html/config.js:ro
      - /dev/null:/etc/nginx/conf.d/default.conf
    networks:
      - saleor-backend-tier

  # 🧩 Backend services — internal only
  api:
    expose:
      - "8000"
    ports: []
    restart: unless-stopped
    networks:
      - saleor-backend-tier
    environment:
      DASHBOARD_URL: http://localhost/dashboard/
      ALLOWED_HOSTS: localhost,127.0.0.1,api
      RSA_PRIVATE_KEY_PATH: /app/keys/jwt.key
      RSA_PUBLIC_KEY_PATH: /app/keys/jwt.key.pub
      EMAIL_BACKEND: django.core.mail.backends.smtp.EmailBackend
      EMAIL_HOST: mailpit
      EMAIL_PORT: "1025"
      EMAIL_HOST_USER: ""
      EMAIL_HOST_PASSWORD: ""
      EMAIL_USE_TLS: "false"
      EMAIL_USE_SSL: "false"
      DEFAULT_FROM_EMAIL: no-reply@vitecover.com
    depends_on:
      keygen:
        condition: service_completed_successfully
    volumes:
      - saleor-keys:/app/keys
    command: >
      sh -c "
        export RSA_PRIVATE_KEY=\"$(cat /app/keys/jwt.key)\" &&
        export RSA_PUBLIC_KEY=\"$(cat /app/keys/jwt.key.pub)\" &&
        echo '✅ RSA keys loaded from /app/keys ...' &&
        exec uvicorn saleor.asgi:application --host 0.0.0.0 --port 8000
      "

  dashboard:
    expose:
      - "80"      # Internal access for nginx /dashboard/
    ports: []     # No host binding
    restart: unless-stopped
    networks:
      - saleor-backend-tier
    env_file:
      - .env.dashboard
    volumes:
      # serves runtime config file if image supports it
      - ./dashboard.config.js:/usr/share/nginx/html/config.js:ro
      
  keygen:
    image: alpine:3.20
    command: >
      sh -c "apk add --no-cache openssl &&
             mkdir -p /keys &&
             [ -f /keys/jwt.key ] ||
             (openssl genrsa -out /keys/jwt.key 2048 &&
              openssl rsa -in /keys/jwt.key -pubout -out /keys/jwt.key.pub) &&
             ls -l /keys"
    volumes:
      - saleor-keys:/keys

  db:
    ports: []     # Internal only
    restart: unless-stopped
    networks:
      - saleor-backend-tier

  redis:
    ports: []
    restart: unless-stopped
    networks:
      - saleor-backend-tier

  jaeger:
    ports: []
    restart: unless-stopped
    networks:
      - saleor-backend-tier

  mailpit:
    ports: []
    restart: unless-stopped
    networks:
      - saleor-backend-tier

  worker:
    restart: unless-stopped
    networks:
      - saleor-backend-tier

networks:
  saleor-backend-tier:
    driver: bridge

volumes:
  saleor-keys:
    driver: local