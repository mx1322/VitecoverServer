events {}

http {
    server {
        listen 80;

        # 关键：设置 server_name
        server_name 127.0.0.1 localhost;

        # GraphQL API, Dashboard, AND Media/Thumbnail (全部代理回后端，简化配置)
        location / {
            # 针对 Saleor API 的转发
            location ~ ^/(graphql/|thumbnail/|media/) {
                proxy_pass http://api:8000;
                # 使用 $http_host 确保端口被传递，Saleor 才能生成正确的 SITE_URL 链接
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                client_max_body_size 20m;
            }

            # Dashboard
            location /dashboard/ {
                proxy_pass http://dashboard:80/;
                proxy_set_header Host $host;
            }

            # Dashboard Config 文件
            location = /config.js {
                alias /usr/share/nginx/html/config.js;
                add_header Cache-Control "no-cache, must-revalidate";
            }

            location ^~ /dashboard/config.js {
                alias /usr/share/nginx/html/config.js;
                add_header Cache-Control "no-cache, must-revalidate";
            }

            # 默认根路径
            location / {
                return 200 'Saleor backend is running.\n';
                add_header Content-Type text/plain;
            }
        }
    }
}